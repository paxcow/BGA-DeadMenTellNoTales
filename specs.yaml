entities:
  - tile:
      - room_tile: { id, doors, color, pips, powder_keg, has_trapdoor }
      - starting_tile: { id, doors, color, pips }
  - token:
      - treasure_guard: { id, side }
      - skeleton_crew_cutlass: { id, side }
      - skeleton_crew_grog: { id, side }
      - trapdoor: { id }
      - action_token: { id, player_id, used }
      - character_battle_token: { id, player_id }
      - captain_fromm_token: { id, side }
  - card:
      - character_card: { id, name, ability }
      - item_card: { id, name, ability }
      - skelits_revenge_card: { id, fire_effects, deckhand_effects, skeleton_crew_movement }
      - dinghy_card: { id }
  - die:
      - fire_die: { id, color, value }
      - battle_die: { id, value }
  - marker:
      - explosion_marker: { id }
  - figure:
      - pirate_figure: { id, player_id, color }
  - board:
      - player_board: { id, player_id, fatigue_dial, battle_track }
  - deckhand: { id }

setup:
  - Place 4 starting tiles and explosion tracker.
  - Place explosion marker on the track.
  - For each of the 4 starting rooms, roll a matching color fire die and place it. Re-roll 6s.
  - Place one deckhand in the room with the trapdoor icon.
  - Place remaining fire dice, deckhands, dinghy card, and battle die aside.
  - Shuffle Skelit's Revenge cards into a face-down stack.
  - Shuffle room tiles into a face-down stack. Offset top tiles (2 * num_players).
  - Put 20 double-sided tokens into the bag.
  - Players choose difficulty level to determine win conditions.
  - Each player gets:
    - 1 Player Board (fatigue at 0).
    - 1 random Character Card.
    - 1 random Item Card.
    - Matching Pirate figure and Battle Token (battle token on 0).
    - 5 Action Tokens (6 for Lydia Lamore).
  - Place remaining Item Cards face up.
  - Place pirate figures on the starting tile boat.

phases:
  - search_the_ship:
      description: "Turn over a room tile and add it to the ship."
  - take_pirate_actions:
      description: "Spend action tokens to perform actions."
  - skelits_revenge:
      description: "Draw and resolve a Skelit's Revenge card."

actions:
  - walk: { cost: 1, description: "Move to an adjacent room." }
  - run: { cost: 1, description: "Move two rooms. Incur extra fatigue." }
  - fight_fires: { cost: 1, description: "Lower fire level in the current room by 1." }
  - eliminate_deckhand: { cost: 1, description: "Remove one deckhand from current or adjacent room." }
  - pick_up_token: { cost: 1, description: "Pick up a Treasure, Cutlass, or Grog token." }
  - rest: { cost: 1, description: "Lower fatigue by 2." }
  - increase_battle_strength: { cost: 1, description: "Move battle marker up one space." }
  - swap_item_card: { cost: 1, description: "Swap your item card with one from the table or another player." }
  - loot: { cost: 1, description: "Pick up a treasure. Limits available actions and increases fatigue gain." }

state_machine:
  states:
    - 1: { name: "gameSetup", type: "game", action: "st_gameSetup", transitions: { "start": 2 } }
    - 2: { name: "playerTurn", type: "activeplayer", possibleactions: ["search", "action", "skelit"], transitions: { "nextTurn": 2, "endGame": 99 } }
    - 10: { name: "searchShip", type: "game", action: "st_searchShip", transitions: { "actions": 11 } }
    - 11: { name: "takeActions", type: "activeplayer", possibleactions: ["walk", "run", "fightFire", "eliminateDeckhand", "pickupToken", "rest", "increaseBattleStrength", "swapItem"], transitions: { "skelit": 12 } }
    - 12: { name: "skelitsRevenge", type: "game", action: "st_skelitsRevenge", transitions: { "nextTurn": 2 } }
    - 20: { name: "battle", type: "activeplayer", action: "st_battle", transitions: { "win": 11, "lose": 11 } }
    - 99: { name: "gameEnd", type: "game", action: "st_gameEnd" }
  args:
    - playerTurn: { active_player_id }
    - takeActions: { available_actions, fatigue_level, battle_strength }
    - battle: { enemy_type, enemy_strength }
  transitions:
    - start: { from: 1, to: 2 }
    - nextTurn: { from: [2, 12], to: 2 }
    - search: { from: 2, to: 10 }
    - actions: { from: 10, to: 11 }
    - skelit: { from: 11, to: 12 }
    - encounterEnemy: { from: 11, to: 20 }
    - win: { from: 20, to: 11 }
    - lose: { from: 20, to: 11 }
    - endGame: { from: "*", to: 99 }

db_schema:
  - player:
      - player_fatigue: INT
      - player_battle_strength: INT
  - room_tile:
      - tile_id: INT
      - x: INT
      - y: INT
      - fire_level: INT
      - has_powder_keg: BOOL
      - powder_keg_exploded: BOOL
  - token:
      - token_id: VARCHAR(32)
      - token_location: VARCHAR(32) # room_id, player_id, 'bag'
      - token_state: INT # side for double-sided tokens
  - deckhand:
      - deckhand_id: INT
      - room_id: INT
  - card:
      - card_id: INT
      - card_type: VARCHAR(16)
      - card_location: VARCHAR(16) # 'deck', 'discard', player_id
      - card_location_arg: INT

notifications:
  - tilePlaced: { args: [tile_id, x, y, fire_die, token], log: "${player_name} places a new room tile." }
  - actionTaken: { args: [player_id, action_type], log: "${player_name} performs ${action_type}." }
  - fireLevelChanged: { args: [room_id, new_level], log: "Fire level in room ${room_id} is now ${new_level}." }
  - explosion: { args: [room_id, type], log: "A ${type} explosion occurs in room ${room_id}!" }
  - deckhandAdded: { args: [room_id], log: "A deckhand appears in room ${room_id}." }
  - skeletonCrewMoved: { args: [from_room_id, to_room_id], log: "Skeleton crew moves from ${from_room_id} to ${to_room_id}." }
  - battleResult: { args: [player_id, enemy, result], log: "${player_name} battles ${enemy} and ${result}." }
  - fatigueChanged: { args: [player_id, new_fatigue], log: "${player_name}'s fatigue is now ${new_fatigue}." }
  - treasureLooted: { args: [player_id, treasure_id], log: "${player_name} has looted a treasure!" }
  - playerDied: { args: [player_id], log: "${player_name} has died!" }

i18n:
  - walk
  - run
  - fight_fires
  - eliminate_deckhand
  - pick_up_token
  - rest
  - increase_battle_strength
  - swap_item_card
  - loot
  - search_the_ship
  - take_pirate_actions
  - skelits_revenge
  - places_a_new_room_tile
  - performs_action
  - fire_level_in_room_is_now
  - explosion_occurs_in_room
  - deckhand_appears_in_room
  - skeleton_crew_moves
  - battles_and_result
  - fatigue_is_now
  - has_looted_a_treasure
  - has_died
